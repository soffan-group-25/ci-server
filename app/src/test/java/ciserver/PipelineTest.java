/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package ciserver;

import static org.junit.Assert.*;

import java.io.File;
import java.io.IOException;

import org.apache.commons.io.FileUtils;
import org.junit.Test;

import com.google.gson.Gson;

public class PipelineTest {

    public static final String PipelineTestingDirectory = "../pipeline_testing";

    @Test
    public void canExecutePipeline() throws IOException {
        var gson = new Gson();
        var event = gson.fromJson(PushEventTest.TestData, PushEvent.class);

        var pipeline = new Pipeline(event);
        assertNotNull(pipeline);

        var status = pipeline.start(TargetStage.ALL, PipelineTestingDirectory);
        assertNotNull(status);

        FileUtils.deleteDirectory(new File(PipelineTestingDirectory));
    }

    @Test
    public void pipelineObserverIsNotified() throws IOException {
        var gson = new Gson();
        var event = gson.fromJson(PushEventTest.TestData, PushEvent.class);

        var pipeline = new Pipeline(event);
        var pipelineObserver = new PipelineObserver() {

            boolean observerIsNotified = false;

            @Override
            public void update(TargetStage stage, PipelineStatus status) {
                observerIsNotified = true;
            }
        };

        pipeline.addObserver(pipelineObserver);
        pipeline.start(TargetStage.ALL, PipelineTestingDirectory);

        assertTrue(pipelineObserver.observerIsNotified);

        FileUtils.deleteDirectory(new File(PipelineTestingDirectory));
    }
}
